\newcounter{myalg}[section]
\newenvironment{myalg}[3] {
  \refstepcounter{myalg}
  \textbf{Algorithm \themyalg}: {#1}(#2) $\rightarrow$ (#3)\newline
}

\input{../../definitions}
\title{\SM{} - Study Guide - Milestone 9: III... coding}

\maketitle

\tableofcontents

\section{Description}

\subsection{Intra (I) video coding}

In the III... (or Intra video) coding, the
\href{https://sistemas-multimedia.github.io/milestones/07-DCT/}{2D
  block-DWT}, the
\href{https://sistemas-multimedia.github.io/milestones/08-DWT/}{2D
  DWT}, or any other spatial transform, is used on sequences of frames
(images) to exploit the spatial correlation. This is achieved by
simply iterating the spatial decorrelation as it is described in the
Algorithm~\ref{alg:III_coding}~\cite{taubman2002jpeg2000}, where $V$
in the input sequence and $S$ controls the number of SRLs (Spatial
Resolution Levels)\footnote{Notice that at least one SRL is always
available for each image or video sequence}. The synthesis transform
is computed using the Algorithm~\ref{alg:III_decoding}. In the
Fig.~\ref{fig:III} there is an example of the decomposition generated
for three frames $V_0$, $V_1$ and $V_2$.

\begin{myalg}{III-coding}{$\mathbf{V}$ /* original video sequence */, $S$ /* Number of extra levels */}{$\mathbf{O}$ /* transformed video sequence */}
  \label{alg:III_coding}
  \begin{enumerate}
  \item ${\mathbf O}=\{\}$ /* empty sequence */.
  \item for ${\mathbf V}_i\in {\mathbf V}$:
    \begin{enumerate}
    \item ${\mathbf O}_i\leftarrow\text{2D-T}^{S}({\mathbf V}_i)$ /* 2D analysis spatial transform */.
    \end{enumerate}
  \end{enumerate}
\end{myalg}

\begin{myalg}{III-decoding}{$\mathbf{O}$ /* transformed video sequence */, $S$ /* Number of extra levels */}{$\mathbf{V}$ /* original video sequence */}
  \label{alg:III_decoding}
  \begin{enumerate}
  \item ${\mathbf V}=\{\}$ /* empty sequence */.
  \item for ${\mathbf O}_i\in {\mathbf O}$:
    \begin{enumerate}
    \item ${\mathbf V}_i\leftarrow\text{2D-T}^{-S}({\mathbf O}_i)$ /* 2D synthesis spatial transform */.
    \end{enumerate}
  \end{enumerate}
\end{myalg}

\begin{figure}
  \centering
  \myfig{graphics/forward_MDWT}{6cm}{600}
  \caption{Decomposition generated by 1-levels ($S=1$) 2D-DWT and the 2x2-DCT (block size is equal to $S+1$).}
  \label{fig:III}
\end{figure}


\section{What do you have to do?}

Try to implement the TODO sections of this \href{https://github.com/Sistemas-Multimedia/Sistemas-Multimedia.github.io/blob/master/milestones/09-III_coding/III_compression.ipynb}{notebook}.

\begin{comment}
\subsection{Intra-coding}

In the previous milestones we have studied how to compress images (or
frames in a sequence of video), performing both a color and a spatial
transformation, and then, using PNG, performing RDO (Rate/Distortion
Optimization). In this milestone we will learn how to perform RDO over
a sequence of frames. Because each frame is encoded independently, we
speak about I (Intra-coded) frames, and III... video coding.

In this milestone we consider the RDO of the sequence of frames.

\subsection{Algorithm}

Basically, we are going to:
\begin{enumerate}
\item YUV-transform each frame of a GOF (Group Of Frames), of length $G$.
\item DCT each YUV component.
\item Build the DCT subbands of each component, generating a
  decomposition of subband-components. For example, for two (usually
  consecutive) frames \verb|A|, and \verb|B|, and a 4x4-DCT applied to
  each frame, we will obtain the decompositions \verb|D_A| and
  \verb|D_B| (only subbands are showed):
\begin{verbatim}
    D_A          D_B
+----------+ +----------+
| A0 A1 A2 | | B0 B1 B2 |
| A3 A4 A5 | | B3 B4 B5 |
| A6 A7 A8 | | B6 B7 B8 |
| A9 Aa Ab | | B9 Ba Bb |
+----------+ +----------+
\end{verbatim}
  where each subband has 3 (YUV) components. \verb|TF| stands for
  Transformed Frame. Notice that in this example we have a total of
  $3*12=36$ subband-components. If $5$ quantization steps were used,
  the total number of points in the RD curve per frame would be
  $36*5=180$. Finally, the total number of RD points in the GOP would
  be $2*180=360$.

\item Find the optimal progression of quantization steps combinations,
  considering the RD points of the $G$ decompositions. Notice that
  YCoCg is near orthogonal and the is orthogonal, and therefore, the
  optimal progression can be determined by simply sorting the RD
  points by their slope in the transform (YCoCg+DCT) domain. To
  estimate the rate of the points we will supose that the impact on
  the rate when encoding a subband-component depends only of such
  subband-component.
  
\item Concatenate in the vertical (Y) dimension the decompositions:
\begin{verbatim}
+----------+
| A0 A1 A2 |
| A3 A4 A5 | D_A
| A6 A7 A8 | 
| A9 Aa Ab |
+----------+ 
| B0 B1 B2 |
| B3 B4 B5 | D_B
| B6 B7 B8 |
| B9 Ba Bb |
+----------+
\end{verbatim}
  This is done basically to avoid using a new PNG header for each
  decomposition.
\end{enumerate}

Please, create an experiment in which the frame quantization step is
different for each frame of a sequence, and another experiment that
uses the same quantization step for all the frames. Compute the
average RD curves. Which one is better? Do you think that
\begin{equation*}
  D = \sum_i D_i,
\end{equation*}
where $D$ is the distortion generated for the complete sequence and
$D_i$ is the distortion only for the $i$-th frame, holds?
\end{comment}

%Try to answer:
%\begin{enumerate}
%\item How many Spatial Resolution Levels (SRL) of
%  $V=\{V_0, V_1, V_2\}$ are accesible from the decomposition of the
%  Fig.~\ref{fig:MDWT} using the $\text{MDWT}^{-1}$?
%\item Please, run the
%  \href{https://sistemas-multimedia.github.io/MRVC/#x1-80004.1}{Example:
%    1-iteration MDWT ($\mathtt{MDWT}(N=5)$)}, and the
%  \href{https://sistemas-multimedia.github.io/MRVC/#x1-90004.2}{Example:
%    2-iterations MDWT ($2\times\mathtt{MDWT}(N=5)$)}.
%\end{enumerate}

\section{Timming}

Please, finish this milestone before the next class session.

\section{Deliverables}

None.

\section{Resources}

\renewcommand{\addcontentsline}[3]{}% Remove functionality of \addcontentsline
\bibliography{JPEG2000}

\begin{comment}
\item Reorder the subbands in the decomposition, generating a single
  2D structure where similar (same frequency) subbands are placed
  together. Continuing with the previous example:
\begin{verbatim}
            frames_per_GOF
              <------->
            ^ +-------+ ^
            | | A0 B0 | |
blocks_in_y | | A3 B3 | |
            | | A6 B6 | |
            | | A9 B9 | |
            v +-------+ |
              | A1 B1 | |
              | A4 B4 | | blocks_in_x*blocks_in_y
              | A7 B7 | |
              | Aa Ba | |
              +-------+ |
              | A2 B2 | |
              | A5 B5 | |
              | A8 B8 | |
              | Ab Bb | |
              +-------+ v
\end{verbatim}
  and it can be seen, the subbands \verb|A0|, \verb|A1|, and
  \verb|A2|, all of them low-frequency subbands are contiguous. This
  should improve the compression ratio provided by PNG.  Notice that
  any other transform that generates subbands (such as the DWT) can be
  used in this stage, although the subbands should be distributed
  considering the descomposition.


\item Interlace the coefficients of those subbands with the same
  frequency. Continuing with the previous example:
\begin{verbatim}
+-------------+
| AB0 AB1 AB2 |
| AB3 AB4 AB5 |
| AB6 AB7 AB8 |
| AB9 ABa ABb |
+-------------+
\end{verbatim}
  where
  \begin{equation}
    {\mathtt ABi}_{j,k} = {\mathtt Ai}_{j,k} | {\mathtt Bi}_{j,k},
  \end{equation}
  where \verb||| denotes the concatenation operator.

  For example, considering the quantization steps $\{128, 64, 32, 16,
  8, 4, 2, 1\}$, the first combination of quantization steps to test
  could be (the combinations must not be applied in this order):
\begin{verbatim}
+-------------+-------------+-------------+-------------+
| 128 inf inf | inf inf inf | inf inf inf | inf inf inf |
| inf inf inf | inf inf inf | inf inf inf | inf inf inf | 
| inf inf inf | inf inf inf | inf inf inf | inf inf inf | 
| inf inf inf | inf inf inf | inf inf inf | inf inf inf | 
+-------------+-------------+-------------+-------------+
\end{verbatim}
  The second one could be:
\begin{verbatim}
+-------------+-------------+-------------+-------------+
|  64 inf inf | inf inf inf | inf inf inf | inf inf inf |
| inf inf inf | inf inf inf | inf inf inf | inf inf inf | 
| inf inf inf | inf inf inf | inf inf inf | inf inf inf | 
| inf inf inf | inf inf inf | inf inf inf | inf inf inf | 
+-------------+-------------+-------------+-------------+
\end{verbatim}
  And the last one:
\begin{verbatim}
+-------------+-------------+-------------+-------------+
|   1   1   1 |   1   1   1 |   1   1   1 |   1   1   1 |
|   1   1   1 |   1   1   1 |   1   1   1 |   1   1   1 | 
|   1   1   1 |   1   1   1 |   1   1   1 |   1   1   1 | 
|   1   1   1 |   1   1   1 |   1   1   1 |   1   1   1 | 
+-------------+-------------+-------------+-------------+
\end{verbatim}
\end{enumerate}

\end{comment}

% Emacs, this is -*-latex-*-

\input{../../definitions}
\title{\SM{} - Study Guide - Milestone 5: Lossy Compression of RGB (Red, Green, and Blue) images}

\maketitle

\tableofcontents

\section{Description}
%{{{

In this milestone we will
\href{https://vicente-gonzalez-ruiz.github.io/quantization/}{quantize}
an image\footnote{Or frame, in the context of a video.} in the
\href{https://en.wikipedia.org/wiki/RGB_color_model}{RGB\footnote{Red,
  Green and Blue: the primary colors.} color domain}. RGB is an
additive color system, which means that all colors \emph{start} with
black and are created by adding some intensity of the primary colors
red, green and blue~\cite{burger2016digital}. Quantizing and then
compressing with PNG we will have a
\href{https://en.wikipedia.org/wiki/Lossy_compression}{lossy image
  compressor}.

%\href{https://en.wikipedia.org/wiki/Visual_system}{Humans} are quite
%efficient recognizing the information stored in images (and videos),
%even when this information has been degraded or partially
%lost. \href{https://en.wikipedia.org/wiki/Quantization_(signal_processing)}
%{Quantization}~\cite{sayood2017introduction,vetterli2014foundations}
%is a technique that can remove the visual information that is less
%relevant for us, and implies a
%\href{https://en.wikipedia.org/wiki/Lossy_compression}{lossy coding},
%which provides
%\href{https://en.wikipedia.org/wiki/Data_compression_ratio}{compression
%  ratios} usually at least one order of magnitude higher than using
%\href{https://en.wikipedia.org/wiki/Lossless_compression}{lossless
%  coding}.

\subsection{Scalar and vector quantization of RGB images}
SQ would be an optimal solution only if the image colors are uniformly
distributed within
\href{https://en.wikipedia.org/wiki/RGB_color_model}{the RGB
  cube}. However, the typical color distribution in natural images is
anything but uniform, with some regions of the color space being
densely populated and many colors entirely missing. In this case,
scalar quantization is not optimal because the interesting colors may
not be sampled with suﬃcient density while at the same time colors are
represented that do not appear in the image at
all~\cite{burger2016digital}.

On the other hand, VQ does not treat the individual RGB (sometimes
also refered by
\href{https://en.wikipedia.org/wiki/Color_image}{channel}s separately
as does scalar quantization, but each color vector
${\mathbf C}_i = ({\mathbf R}_i, {\mathbf G}_i, {\mathbf B}_i )$ (or
pixel) in the image is treated as a single entity. Starting from a set
of original color tuples ${\mathbf C} = \{c_1, c_2, \ldots ,c_m\}$,
the task of vector quantization is:
\begin{enumerate}
\item to ﬁnd a set of $n$ representative color vectors
  ${\mathbf C}' = \{c'_1, c'_2 ,\ldots , c'_n \}$, and
\item to replace each original color ${\mathbf C}_i$ by one of the new
  color vectors ${\mathbf C}'_j\in {\mathbf C}'$, where $n$ is usually
  predetermined ($n < m$) and the resulting deviation from the
  original image shall be minimal. This is a combinatorial
  optimization problem in a rather large search space, which usually
  makes it impossible to determine a global optimum in adequate
  time. This is the reason why VQ methods only compute a ``local''
  optimum at best~\cite{burger2016digital}. Anyway, VQ is used in
  \href{https://en.wikipedia.org/wiki/Palette_(computing)}{``palletized''
    images}.
\end{enumerate}

Another key aspect to take into consideration is that the problem
previously mentioned about the under-optimality when quantizing
directly in the RGB domain can be minimized when the values of each
channel are decorrelated (using for example a color transform as we
will see in a future milestone), requesting in general less
computation than VQ.

\subsection{Quantization in the RGB domain}
Supposing that we are using a dead-zone quantizer, a color RGB image
can be quantized, channel by channel, using quantization steps
$\Delta_{\text{R}}$, $\Delta_{\text{G}}$, and $\Delta_{\text{B}}$. A
reasonable question that arises here is: given a target bit-rate $R$
for the compressed frame, how the quantization steps should be chosen
to minimize the distortion?

At this point we can consider two different optimization
perspectives. In the first one, we consider strictly visual
considerations, and obviously, any alternative different from
\begin{equation}
  \Delta_{\text{R}} = \Delta_{\text{G}} = \Delta_{\text{B}}
  \label{eq:simple_Q}
\end{equation}
will produce some alteration in the color (also called the
``chroma'') of the reconstructed frame.

In the second perspective, only a pure
\href{https://en.wikipedia.org/wiki/Rate-distortion_theory}{Rate/Distortion
  (RD) performance} is considered. From a RD point of view, the best
combination of quantization steps is those that optimizes (generally
by minimizing, that is, making it closer to the origin of coordinates)
the RD curve.\footnote{Notice that a RD curve represents the trade-off
between the distortion (typically the
\href{https://en.wikipedia.org/wiki/Root-mean-square_deviation}{Root
  Mean Square Error (RMSE)}) and the bit-rate (therefore, RMSE versus
bit/pixel).}

\begin{figure}
  \centering
  \myfig{graphics/RD_slopes}{3cm}{300}
  \caption{Two RD curves with different shape.}
  \label{fig:RD_slopes}
\end{figure}

Normal RD curves are convex (see Fig.~\ref{fig:RD_slopes}), which
means that if $\lambda_i$ is the slope of the curve measured at the
$i$-th point of the curve (starting at the lowest bit-rate), it
usually hold that
\begin{equation}
  \lambda_i > \lambda_{i+1}.
\end{equation}
where $\lambda$ quantifies the trade-off between decreasing the
distortion\footnote{For this reason, the slopes are negative.} while
the bit-rate increases. Notice that, the higher the slope, the higher
the benefit in terms of RD. If we suppose now that the contribution to
the quality of each channel is additive, that is
\begin{equation}
  D = D_{\text{R}} + D_{\text{G}} + D_{\text{B}},
  \label{eq:additive}
\end{equation}
where $D$ denotes distortion, then the optimal quantization steps must
satisfy that~\cite{vetterli1995wavelets,sayood2017introduction}
\begin{equation}
  \lambda_{\text{R}} = \lambda_{\text{G}} = \lambda_{\text{B}}.
  \label{eq:optimal_quantization}
\end{equation}

To see this, lets suppose that we have used, for example, a set of QSs
so that $\lambda_{\text{R}}/2 = \lambda_{\text{G}} =
\lambda_{\text{B}},$ and that we still have room for more bits to
encode the frame. In this situation, the maximum benefit would be
obtained if and only if we decrease $\Delta_{\text{R}}$, because the
slope for the red channel doubles the slope of the other
curves. Therefore, the optimal quantization steps are obtained when
Eq.~\ref{eq:optimal_quantization} is true. This can be seen in this
\href{https://github.com/Sistemas-Multimedia/Sistemas-Multimedia.github.io/blob/master/milestones/05-RGB_compression/RGB_compression.ipynb}{notebook}.

As it has been indicated, the previous quantization steps pattern (see
Equation~\ref{eq:simple_Q}) can be used to find the optimal RD curve
that relates distortion versus bit-rate. However, it is important to
realize that such relation between the quantization steps can be
determined because the contribution to the distortion, in the case of
compression RGB images, satisfy two key properties:
\begin{enumerate}
\item The contributions of the channels are independent (see
  Eq.~\ref{eq:additive}), and therefore, the total distortion is a
  linear combination of individual distortions.
\item The constribution to the distortion of each channel is exactly
  the same.
\end{enumerate}

%}}}

\section{What do I have to do?}
%{{{

\begin{enumerate}
\item Please, using this
  \href{https://github.com/Sistemas-Multimedia/Sistemas-Multimedia.github.io/blob/master/milestones/05-RGB_compression/RGB_compression.ipynb}{notebook}
  try to find a quantization steps combination where
  Eq.~\ref{eq:simple_Q} is not optimal (or at least there is a
  different configuration of QSs better that this equation).
\item Do you think that our lifes would be easier, to compress a RGB
  image, if we had an gray-image (lossy) compressor that allows to
  select the quantization step by its slope?
\end{enumerate}
%\begin{enumerate}
%\item Please, modify this
%  \href{https://github.com/Sistemas-Multimedia/Sistemas-Multimedia.github.io/blob/master/milestones/05-quantization/performance.ipynb}{notebook}
%  in order to use the
%  \href{https://docs.opencv.org/master/d4/da8/group__imgcodecs.html}{TIFF
%    and JPEG 2000 image formats} instead of PNG. Compare the RD
%  curves.
%\item In the previous
%  \href{https://github.com/Sistemas-Multimedia/Sistemas-Multimedia.github.io/blob/master/milestones/05-quantization/performance.ipynb}{notebook}
%  the three color channels, R, G, and B has been quantized using the
%  same QS ($\Delta_{\text{R}} = \Delta_{\text{G}} =
%  \Delta_{\text{B}}$). Do you think that this strategy minimizes the
%  quantization error?
%\item Compare the estimation provided by the entropy with the
%  DEFLATE's bit-rates.
%\end{enumerate}

%}}}

\section{Timming}

Please, finish this milestone before the next class session.

\section{Deliverables}

None.

\section{Resources}

\renewcommand{\addcontentsline}[3]{} % Remove functionality of \addcontentsline
\bibliography{data-compression,signal-processing,DWT,image-processing}
